# SIEM Agent — агент сбора и анализа логов безопасности

**Тема:** Разработка агента для системы безопасности (SIEM) для сбора и анализа логов  
**Цель:** Получить практические навыки в разработке систем мониторинга, работе с системными логами, создании агентов сбора данных и интеграции с системами хранения и анализа информации.

---

## Возможности

### Основная функциональность
- **Мониторинг логов в реальном времени**: inotify + polling fallback
- **Поддержка источников**:
  - auditd logs (`/var/log/audit/audit.log`)
  - Системные логи (`/var/log/syslog`, `/var/log/auth.log`)
  - История команд пользователей (`~/.bash_history`)
- **Обработка ротации логов**: автоматическое определение и перечтение
- **Сохранение позиций**: возобновление с места остановки
- **Буферизация событий**: память + резервное копирование на диск
- **Надёжная доставка**: retry логика, пакетная отправка
- **Работа в режиме демона**: фоновая работа с обработкой сигналов

### Парсеры логов
- **AuditdParser**: структурированный парсинг событий аудита
- **SyslogParser**: анализ системных логов и событий аутентификации
- **BashHistoryParser**: мониторинг командной истории пользователей

### Интеграция
- **Совместимость с СУБД**: отправка в NoSQL СУБД из предыдущих работ
- **Стандартизированный формат**: единая структура событий безопасности
- **Конфигурируемость**: гибкие настройки через JSON

---

## Архитектура проекта

```text
no_sql_dbms/
│
├── include/                             # Заголовочные файлы
│     ├── utils.hpp
│     ├── vector.hpp                     # Собственный Vector
│     ├── algorithms.hpp                 # Собственные алгоритмы
│     ├── hash_map.hpp                   # Собственная HashMap
│     ├── query_evaluator.hpp
│     ├── btree_index.hpp                # Собственное B-Tree
│     └── collection.hpp
│
├── src/                                 # Реализация модулей
│     ├── utils.cpp
│     ├── query_evaluator.cpp
│     ├── btree_index.cpp
│     ├── collection.cpp
│     ├── main.cpp                       # CLI-интерфейс (Практика 1)
│     ├── db_server.cpp                  # TCP-сервер (Практика 2)
│     └── db_client.cpp                  # Сетевой клиент (Практика 2)
│
├── parcer/json.hpp                      # nlohmann JSON-парсер
│
├── siem_agent/
│       ├──include/                      # Заголовочные файлы агента
│         ├── agent.hpp                  # Главный класс агента
│         ├── config.hpp                 # Конфигурационный менеджер
│         ├── event.hpp                  # Структура события безопасности
│         ├── event_buffer.hpp           # Буфер событий
│         ├── log_collector.hpp          # Сборщик логов
│         ├── db_sender.hpp              # Отправитель в СУБД
│         └── position_manager.hpp       # Менеджер позиций чтения
│       ├── src/                         # Реализация модулей
│         ├── agent.cpp                  # Основная логика агента
│         ├── config.cpp                 # Загрузка/сохранение конфигурации
│         ├── event.cpp                  # Реализация SecurityEvent
│         ├── event_buffer.cpp           # Буфер с дисковым кэшированием
│         ├── log_collector.cpp          # Парсеры и мониторинг логов
│         ├── db_sender.cpp              # TCP-клиент для СУБД
│         ├── position_manager.cpp       # Управление позициями файлов
│         └── main.cpp                   # Точка входа
│       ├── configs/                      # Конфигурационные файлы
│         └── agent_config.json          # Пример конфигурации
│
├── systemd/                             # Демонизация агента на уровне системы
│      ├── install.sh
│      └── siem-agent.service
│
├── Makefile
│
└── databases/                           # Хранилище данных
```

---

## Использование

### Сборка

```bash
# Полная сборка (СУБД + SIEM Agent)
make clean
make

# Только SIEM Agent
make siem_agent_bin
```

### Запуск

```bash
# Простой запуск с конфигом по умолчанию
./siem_agent_bin

# Запуск с указанием конфигурации
./siem_agent_bin --config siem_agent/configs/agent_config.json

# Запуск в режиме демона (фоновая работа)
./siem_agent_bin --config configs/agent_config.json --daemon

# Показать справку
./siem_agent_bin --help
```

### Запуск с тестовой СУБД

1. Запуск сервера СУБД:
```bash
./db_server 8080 ./databases
```

2. Запуск SIEM агента:
```bash
./siem_agent_bin --config siem_agent/configs/agent_config.json
```

3. Проверка данных через клиент СУБД:
```bash
./db_client --host 127.0.0.1 --port 8080 --database security_events --command "FIND {}"
```

---

## Тестирование

**Функциональное тестирование**:
- Сбор логов из всех трёх источников
- Обработка ротации файлов (logrotate)
- Сохранение и восстановление позиций
- Inotify мониторинг в реальном времени
- Fallback на polling при недоступности inotify
- Пакетная отправка с retry логикой
- Работа в режиме демона

**Интеграционное тестирование**:
- Отправка данных в СУБД (порт 8080)
- Корректный JSON формат событий
- Многопоточная обработка
- Обработка сигналов (SIGINT, SIGTERM)

**Тестирование производительности**:
- Буферизация 1000+ событий в памяти
- Дисковое резервное копирование
- Многопользовательские истории команд
- Одновременный мониторинг 10+ файлов

---

## Требования

- C++17 компилятор (g++ 9.0+)
- Linux система (для inotify и системных логов)
- Доступ к логам: чтение /var/log/ (требуются права)
- Сетевое соединение с сервером СУБД

---

## Безопасность

- Агент требует привилегированных прав для чтения системных логов
- Рекомендуется запускать от root или через sudo
- Конфигурационные файлы защищены от случайного изменения
- Позиции файлов хранятся в защищённой директории (/var/lib/siem-agent/)
